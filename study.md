# TravelMind 学习路线 v1.0（对齐 requirement/design/task）

## 1. 学习目标与原则

本路线用于把你当前项目学习拆成「能落地到 `task.md` 的实战路线」：  
每次只推进 1 个任务，形成 1 个 small PR，并在 10~20 分钟内可完成 review。

学习原则：
- 先主链路、后增强：优先 P0，再 P1。
- 先理解控制面，再做功能：先搞懂 LangGraph + SSE + schema。
- 引入 DeepAgents 时，严格遵守“LangGraph 唯一控制面，DeepAgents 仅节点执行器”。
- DeepAgents 默认关闭：M1 不作为主线必选，M2 依据触发条件再启用。
- DeepResearch 默认关闭：作为复杂问题增强子流，M2 依据触发条件灰度启用。
- 每次学习都要产出：代码改动 + 本地验证 + 风险/回滚说明。
- 每个任务都映射三份文档：`requirement.md`（为什么做）+ `design.md`（做成什么样）+ `task.md`（具体做什么）。
- 禁止改目录结构、禁止大重构、禁止改与当前任务无关的 API。

---

## 2. 学习地图（M1~M4）

- **M1 主链路**：从“能生成结构化行程”开始，打通输入 -> 澄清 -> 生成 -> 输出。
- **M2 对话共创 + 证据链路**：把行程规划接入多轮对话，并引入 provider 抽象、降级策略、evidence 归因。
- **M3 编辑链路强化**：完善 Edit Day N、revision/diff、幂等与回滚体验。
- **M4 工程化**：导出、契约测试、回归样例、指标和发布稳定性。

建议节奏（可按你时间调整）：
- 每天 1 个任务（工作日）或每周 3~5 个任务。
- 每完成 3~4 个任务做一次阶段复盘（看是否偏离 requirement/design）。

---

## 3. 单任务学习闭环（固定模板）

每次你让我做一个任务时，按这个闭环学习：

1) **先读（10~20 分钟）**
- 读 `task.md` 对应任务条目（目标/依赖/验收/范围）。
- 在 `design.md` 找对应流程与契约段落。
- 在 `requirement.md` 找对应用户价值和验收点。

2) **再做（30~60 分钟）**
- 只改任务建议范围内的文件，避免扩散。
- 保持 small PR：一个任务一个提交主题。
- 若预估超过 60 分钟，先拆分任务再实现。

3) **最后验（10~20 分钟）**
- 跑 1~3 条本地验证命令。
- 记录风险点（2~3 条）和回滚方式（尤其 DB/契约）。
- 确认能映射到 requirement/design/task 三者。

---

## 4. 分里程碑最佳学习路线（按任务顺序）

## M1：先把“生成可用行程”跑通

### 学习主线目标
- 搞懂旅行域主链路：约束追问 -> 结构化草案 -> 校验修复 -> 终态输出。
- 搞懂控制面：LangGraph 如何驱动节点流转与 resume。
- 搞懂 DeepAgents 的接入边界：只做节点执行，不做控制面。
- 搞懂接口面：SSE 事件如何被前端消费。
- 理解 M1 的 QP 最小职责：意图识别 + 关键约束抽取（不要求完整召回/排序）。

### 推荐任务顺序（对齐 `task.md`）
1. `T-M1-001`  
2. `T-M1-002`  
3. `T-M1-008`（首次落库前必须完成）  
4. `T-M1-003`  
5. `T-M1-004a`  
6. `T-M1-004b`  
7. `T-M1-004c`  
8. `T-M1-004d`  
9. `T-M1-005`  
10. `T-M1-006`  
11. `T-M1-007`（可后置）

可选分支（非 M1 主线）：
- `T-M1-009`（DeepAgents 澄清环节试点）：仅在触发条件满足后开启。

### 每个任务你要重点学什么（与上方推荐顺序一一对应）
1. `T-M1-001`：schema 设计边界、P0/P1/P2 必填与降级思想。
2. `T-M1-002`：revision 与 itinerary 数据模型、`revision_id`/`base_revision_id` 语义。
3. `T-M1-008`：迁移脚本、回滚、重复执行稳定性。
4. `T-M1-003`：路由语义迁移（电商到旅行）的判定逻辑。
5. `T-M1-004a`：澄清回路、`resume`、多轮状态承接，以及硬门槛/软门槛的取舍。
6. `T-M1-004b`：无 provider 情况下如何先形成最小 days/slots。
7. `T-M1-004c`：Pydantic/Schema 校验、自动修复、`final_text` 降级。
8. `T-M1-004d`：`final_itinerary + explanation` 双输出策略。
9. `T-M1-005`：SSE envelope 一致性和事件兼容性。
10. `T-M1-006`：前端最小可视化承接（阶段 + 终态）。
11. `T-M1-007`：旧页面兼容路由策略（旧入口可访问，新入口默认主流程）。
- `T-M1-009`（可选）：DeepAgents 如何增强澄清多轮，同时不破坏 LangGraph 状态真值。

### 关键读码路径（建议）
- 后端入口与流式：`llm_backend/main.py`
- 编排与状态：`llm_backend/app/lg_agent/lg_builder.py`
- schema 与模型：`llm_backend/app/schemas/`、`llm_backend/app/models/`
- 前端接流：`frontend/DsAgentChat_web/src/services/api.ts`
- 主视图：`frontend/DsAgentChat_web/src/views/`

### M1 最小回归输入（每次 M1 任务都跑）
- 用例 1（标准输入）：`上海 4 天，预算 6000，情侣，自由行，偏好文化+美食`
- 用例 2（缺字段追问）：`想去海边玩几天，轻松一点`
- 用例 3（预算冲突）：`北京 3 天，预算 1500，亲子，想住市中心+热门景点`

每次提交的最小预期：
- 用例 1：可输出结构化 `final_itinerary`（或对应成功终态）。
- 用例 2：必须先澄清，不直接输出完整行程。
- 用例 3：输出风险/假设/降级提示，不应静默失败。

---

## M2：先打通“对话式共创”，再做证据增强

### 学习主线目标
- 理解“对话式行程编辑”最小闭环：会话态 -> 意图路由 -> patch apply -> 新 revision。
- 理解下层搜索能力链路：`QP -> Recall -> Ranking -> Rule Filter -> Evidence Builder`。
- 理解 QP 的定位：给召回/排序提供结构化输入，而不是替代 Agent 控制面。
- 理解召回与排序职责边界：召回重覆盖、排序重质量、过滤保可执行。
- 理解为什么旅行场景下规则过滤优先级高（预算/时间/闭馆/通勤等硬约束）。
- 理解 provider 抽象层的价值：解耦厂商、统一错误语义、可降级。
- 理解 evidence 从抓取到展示的最小闭环。
- 理解“可用优先”的系统策略：限流、上限 N、降级不中断。
- 理解 DeepAgents 在长对话中的作用：任务拆解、上下文压缩、轮次收敛。
- 理解 DeepResearch 的边界：复杂问题增强而非默认主链，且必须可回退。
- 理解前端 UX 对齐 Agent 产品的核心原则：双栏联动、SSE 驱动状态流、骨架屏/流式渲染、空态/异常态兜底。

### 推荐任务顺序
1. `T-M2-001`  
2. `T-M2-000a`  
3. `T-M2-010`  
4. `T-M2-011`  
5. `T-M2-012`  
6. `T-M2-013`  
7. `T-M2-014`  
8. `T-M2-015`（前端交互骨架：双栏联动 + 状态反馈 + 空态/异常态）  
9. `T-M2-000b`  
10. `T-M2-000c`  
11. `T-M2-000d`  
12. `T-M2-002a`  
13. `T-M2-002b`  
14. `T-M2-006`  
15. `T-M2-003`  
16. `T-M2-000e`  
17. `T-M2-004`  
18. `T-M2-005`  
19. `T-M2-016`（P1：流式体验与视觉精修）  
20. `T-M2-017`（P1：响应式适配与无障碍基础）  
21. `T-M2-002c`（P1，最后做）  
22. `T-M2-007`（可选：DeepAgents 多轮策略增强）  
23. `T-M2-008`（可选：DeepResearch 深度研究子流）  
24. `T-M2-009a/b/c/d`（可选：BERT/向量召回/LTR/DeepSearch）

### 每个任务你要重点学什么（与上方推荐顺序一一对应）
1. `T-M2-001`：抽象接口如何防止业务层绑定具体 provider。
2. `T-M2-000a`：QP 输出如何统一上游 query 与下游召回输入。
3. `T-M2-010`：会话级 itinerary 状态为什么是对话共创的前提。
4. `T-M2-011`：create/edit/qa/reset 路由如何避免“每轮整单重算”。
5. `T-M2-012`：patch 操作语义与 apply 后校验。
6. `T-M2-013`：diff/revision 如何通过 SSE 回传并保证兼容。
7. `T-M2-014`：聊天区与行程区同屏联动的状态管理方法。
8. `T-M2-015`：为什么 Agent 产品采用双栏联动（Chat + Panel）而非单栏；SSE 事件如何映射到组件状态机（Empty/Clarifying/Streaming/Complete/Error）；EmptyState 和 ErrorState 对用户留存的影响。
9. `T-M2-000b`：多路召回聚合的工程边界（覆盖优先、可回退）。
10. `T-M2-000c`：可解释规则打分与排序可观测性。
11. `T-M2-000d`：硬约束过滤如何保障可执行性与安全性。
12. `T-M2-002a`：配置化策略与调用上限 N 的治理思路。
13. `T-M2-002b`：assumptions/risk 作为降级可解释出口。
14. `T-M2-006`：离线 fixture 对开发效率与回归稳定性的意义。
15. `T-M2-003`：evidence 字段、归因、跳转与合规边界。
16. `T-M2-000e`：候选到 evidence/refs 的映射与可追溯性。
17. `T-M2-004`：覆盖率口径（slot 主 POI）和统计边界。
18. `T-M2-005`：前端证据卡片与推荐项关联的体验设计。
19. `T-M2-016`：骨架屏 vs spinner 对感知延迟的差异；流式逐字渲染的实现（SSE chunk -> DOM 增量）；证据抽屉交互模式参考（Perplexity sidebar）；动效克制原则（仅状态切换用过渡，不加装饰性动画）。
20. `T-M2-017`：CSS Container Queries / Media Queries 的响应式断点策略；键盘导航与焦点管理（Tab order、focus trap）；WCAG 2.1 AA 级对比度要求及检查工具。
21. `T-M2-002c`：并行优化与稳定性权衡。
22. `T-M2-007`：长对话下任务拆解/压缩/收敛策略的工程落地。
23. `T-M2-008`：复杂问题的多来源核验、冲突对比与降级回退。
24. `T-M2-009a/b/c/d`：模型增强如何做到可插拔、可开关、可回退。

### 关键读码路径（建议）
- 服务层：`llm_backend/app/services/`
- agent 节点：`llm_backend/app/lg_agent/`
- 前端组件：`frontend/DsAgentChat_web/src/components/`
- 前端视图：`frontend/DsAgentChat_web/src/views/TravelPlanner.vue`

---

## M3：掌握“Edit Day N + revision 思维”

### 学习主线目标
- 掌握局部编辑不扩散的基本原则。
- 理解 revision/diff 的数据语义与用户感知。
- 理解幂等、回滚、阈值确认这些工程保护机制。

### 推荐任务顺序
1. `T-M3-001a`  
2. `T-M3-001b`  
3. `T-M3-002`  
4. `T-M3-003`  
5. `T-M3-004`  
6. `T-M3-001c`（P1）  
7. `T-M3-005`（P1）

### 每个任务你要重点学什么（与上方推荐顺序一一对应）
1. `T-M3-001a`：最小 Edit API 与“只改 Day N”约束。
2. `T-M3-001b`：何时允许邻接扩散，如何可解释。
3. `T-M3-002`：`changed_days` 与 change summary 的产品价值。
4. `T-M3-003`：`request_id` 幂等与回滚操作的可靠性设计。
5. `T-M3-004`：超阈值交互对用户决策的影响。
6. `T-M3-001c`：锁定日与全局重规划建议策略。
7. `T-M3-005`：修订链可视化与历史可追溯体验。

### 关键读码路径（建议）
- 修订服务：`llm_backend/app/services/revision_service.py`（或实际对应实现）
- API 接口：`llm_backend/main.py`
- 前端编辑页：`frontend/DsAgentChat_web/src/views/TravelPlanner.vue`

---

## M4：工程化收口（让功能可持续）

### 学习主线目标
- 把“能跑”提升到“能稳定迭代”。
- 掌握契约测试、回归样例、导出规范、指标体系。

### 推荐任务顺序
1. `T-M4-001`  
2. `T-M4-002`  
3. `T-M4-003a`  
4. `T-M4-003b`  
5. `T-M4-003c`（P1）  
6. `T-M4-004`（P1）  
7. `T-M4-005`（P1）

### 每个任务你要重点学什么（与上方推荐顺序一一对应）
1. `T-M4-001`：JSON 导出契约与数据结构约定。
2. `T-M4-002`：Markdown 导出格式与可读性。
3. `T-M4-003a`：后端 schema/SSE 契约测试怎么防回归。
4. `T-M4-003b`：前端解析兼容测试怎么防协议变更事故。
5. `T-M4-003c`：快照回归如何提高重构安全感。
6. `T-M4-004`：指标如何驱动后续优化优先级。
7. `T-M4-005`：发布前 checklist 的工程价值。

### 关键读码路径（建议）
- 测试目录：`llm_backend/tests/`、`frontend/DsAgentChat_web/tests/`
- 导出服务：`llm_backend/app/services/`
- 文档与发布说明：`docs/`、`README.md`

---

## 5. 你每周可以这样学（建议版）

### 第 1 周（M1 核心）
- 完成：`T-M1-001`、`T-M1-002`、`T-M1-008`、`T-M1-003`、`T-M1-004a`
- 目标：看懂主链路和澄清闭环

### 第 2 周（M1 收口 + M2 起步）
- 完成：`T-M1-004b`、`T-M1-004c`、`T-M1-004d`、`T-M1-005`
- 目标：稳定输出结构化结果并能前端展示

### 第 3 周（M2 地基：Provider 抽象 + QP + 会话态 + 意图路由）
- 完成：`T-M1-006`、`T-M2-001`、`T-M2-000a`、`T-M2-010`、`T-M2-011`
- 目标：打通“Provider 抽象 + QP 统一输出 + 会话态 + 意图路由”地基（连续编辑前置条件）

### 第 4 周（M2 收口 + 前端骨架）
- 完成：`T-M2-012`、`T-M2-013`、`T-M2-014`、`T-M2-015`
- 目标：完成“patch 编辑 + diff SSE + 前端同屏联动”最小闭环

### 第 5 周（M2 Provider 实现/Evidence + 前端精修）
- 完成：`T-M2-002a`、`T-M2-002b`、`T-M2-006`、`T-M2-003`、`T-M2-000e`、`T-M2-004`
- 可选 P1：`T-M2-016`（流式体验与视觉精修）、`T-M2-017`（响应式与无障碍）
- 目标：补齐证据与降级能力；前端体验从"能用"进阶到"好用"

### 第 6 周（M3 起步 + DeepAgents/DeepResearch 评估窗口）
- 完成：`T-M3-001a`（Edit Day N 起步）
- 完成：`T-M3-003`、`T-M3-004`、`T-M3-001c`、`T-M3-005`
- 可选：触发条件满足时执行 `T-M1-009`、`T-M2-007`、`T-M2-008`
- 目标：完成修订链与稳定性保护，并决定是否启用 DeepAgents/DeepResearch

### 第 7 周（M4）
- 完成：`T-M4-001`、`T-M4-002`、`T-M4-003a`、`T-M4-003b`
- 目标：契约与测试稳定

### 第 8 周（M4 增强）
- 完成：`T-M4-003c`、`T-M4-004`、`T-M4-005`
- 目标：可持续发布与可观测

---

## 6. 每次让助手执行任务时的提问模板（建议直接复用）

你可以每次这样下达任务，保证学习和产出都稳定：

```text
请执行 task.md 的 <任务ID>。
要求：
1) 先用 5~10 条说明解释这个任务在 requirement/design/task 中的位置；
2) 再最小改动实现（small PR）；
3) 输出“单任务交付规范”6 个小标题：
   - 任务目标与范围
   - 改动文件清单（新增/修改）
   - 实现说明（仅本任务）
   - 本地验证步骤（1~3 条命令 + 预期结果）
   - 风险点（2~3 条）与回滚方式
   - 后续建议（可选，不阻断本任务）
4) 不做与本任务无关的重构，不改目录结构，不做大重构，不改无关 API。
```

---

## 7. 学习完成判定（你是否真正学会）

当你满足下面 4 条，就说明这条路线走通了：
- 你能解释主链路里每个关键事件（`stage_start` 到 `final_itinerary/final_text`）的意义。
- 你能独立说明 Edit Day N 为什么需要 revision/diff/幂等/回滚。
- 你能用证据覆盖率和降级策略解释“为什么这版结果可信但不完美”。
- 你能把任一任务压缩为 small PR，并在 10~20 分钟内完成 review。

---

## 8. DeepAgents 启用决策清单（每周复盘一次）

满足任意 2 条，再启用 `T-M1-009/T-M2-007`：
- 澄清轮次常态 >3 轮，且用户中断率上升。
- 长对话中出现明显上下文丢失/漂移。
- 单节点提示词维护复杂度明显上升，改动风险变大。

---

## 9. DeepResearch 启用决策清单（每周复盘一次）

满足任意 2 条，再启用 `T-M2-008`：
- 证据覆盖率持续低于目标阈值（且常规优化效果不明显）。
- 高时效/高不确定问题占比上升（例如天气、政策、营业状态冲突）。
- 标准检索出现冲突信息，用户对“依据可信度”质疑频率升高。
