# M1 本地验收指南

**不需要部署到服务器**，在本地同时启动后端 + 前端开发服务即可验收。

---

## 一、启动服务（两个终端）

### 1. 启动后端

工作目录：`backend/deepseek_agent/llm_backend`

```bash
cd 1、Agent/code/code/backend/deepseek_agent/llm_backend
python run.py
```

- 后端地址：**http://localhost:8000**
- 健康检查：浏览器访问 http://localhost:8000/health 应返回 `{"status":"ok"}`

### 2. 启动前端

工作目录：`frontend/DsAgentChat_web`

```bash
cd 1、Agent/code/code/frontend/DsAgentChat_web
npm install
npm run dev
```

- 前端地址：**http://localhost:3000**（见 vite.config.ts 的 `server.port`）
- 前端会通过 Vite 代理把 `/api` 请求转发到 `http://localhost:8000`，因此 `.env` 里 `VITE_API_BASE_URL` 留空即可（请求走同源 + 代理）

---

## 二、登录与进入旅行规划页

1. 浏览器打开 **http://localhost:3000**
2. 若未登录，先走登录/注册流程（旅行规划页需要认证）
3. 在首页点击 **「旅行规划」** 进入 `/travel` 页面

---

## 三、M1 最小回归用例（study.md 约定）

在旅行规划页的输入框依次用下面三条输入验收：

| 用例 | 输入内容 | 预期 |
|-----|----------|------|
| **用例 1（标准输入）** | `上海 4 天，预算 6000，情侣，自由行，偏好文化+美食` | 出现结构化行程草案（有天数、时段、目的地、预算说明），且无澄清追问 |
| **用例 2（缺字段）** | `想去海边玩几天，轻松一点` | 先出现**澄清**（追问目的地、天数、预算等），不直接给出完整行程 |
| **用例 3（预算紧张）** | `北京 3 天，预算 1500，亲子，想住市中心+热门景点` | 能给出行程或可解释的提示（如假设/风险说明），不应静默失败 |

---

## 四、验收检查点

- **用例 1**：页面能展示 `final_itinerary`（例如多天、上午/下午/晚上槽位、目的地、预算汇总）。
- **用例 2**：先出现澄清阶段（阶段状态/文案），要求补全信息，不直接出完整行程。
- **用例 3**：有结构化结果或明确文案提示，不白屏、不无提示报错。

可选：打开浏览器开发者工具 → Network，筛选 XHR/Fetch，看请求是否发到 `/api/travel/query`，响应是否为 SSE（`text/event-stream`），事件里是否有 `stage_start`、`stage_progress`、`final_itinerary` 或 `final_text`。

---

## 五、仅测后端（不跑前端）时

若只想验证接口，可用 curl（需先登录拿到 token，或接口未强制 token 时去掉 Header）：

```bash
# 用例 1：标准输入（替换 YOUR_TOKEN 为实际 token，或去掉 -H 若未做鉴权）
curl -X POST "http://localhost:8000/api/travel/query" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "query=上海 4 天，预算 6000，情侣，自由行，偏好文化+美食" \
  -F "user_id=1" \
  -N
```

应看到 SSE 流式输出，其中包含 `event: final_itinerary` 或 `event: final_text` 及对应 `data:` JSON。

---

## 六、常见问题

- **前端请求 404**：确认后端已启动在 8000 端口，且前端通过 3000 访问（走代理）。
- **CORS 报错**：后端已允许 `allow_origins=["*"]`，一般不会出现；若直接访问 8000 端口则不存在跨域。
- **未登录无法进旅行页**：设计如此，需先登录再点「旅行规划」。
- **Windows 启动报错 `DLL load failed while importing _uuid_utils`**：已在 `main.py` 开头对 Windows 做了兼容：在导入任何依赖前注入 `uuid_utils` 的桩模块，用标准库 `uuid.uuid4()` 替代有问题的 C 扩展，无需再改环境。若仍报错，可尝试在项目虚拟环境内执行 `pip install uuid-utils --force-reinstall --no-cache-dir` 或安装 [Microsoft Visual C++ 2015–2022 Redistributable](https://learn.microsoft.com/zh-cn/cpp/windows/latest-supported-vc-redist)。

按上述步骤即可在本地完成 M1 验收，无需部署到线上环境。
